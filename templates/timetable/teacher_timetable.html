{% extends 'base.html' %}

{% block title %}Teacher Timetable Lookup - EDUPLANNER{% endblock %}

{% block extra_css %}
<style>
    /* ========== BREADCRUMB ========== */
    .tt-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .tt-breadcrumb a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .tt-breadcrumb a:hover {
        text-decoration: underline;
    }

    .tt-breadcrumb .separator {
        color: var(--text-muted);
    }

    .tt-breadcrumb .current {
        color: var(--text-heading);
        font-weight: 600;
    }

    /* ========== STEP INDICATOR ========== */
    .step-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .step-dot {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
        background: var(--bg-secondary);
        color: var(--text-muted);
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .step-dot.active {
        background: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
    }

    [data-theme="dark"] .step-dot.active {
        color: #13273F;
    }

    .step-dot.completed {
        background: var(--success-color);
        color: #fff;
        border-color: var(--success-color);
    }

    .step-line {
        flex: 0 0 40px;
        height: 2px;
        background: var(--border-color);
        transition: background 0.3s ease;
    }

    .step-line.active {
        background: var(--primary-color);
    }

    .step-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    /* ========== SEARCH BAR ========== */
    .search-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-wrapper .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1rem;
    }

    .search-wrapper input {
        padding-left: 42px;
        padding-right: 14px;
        height: 48px;
        font-size: 0.95rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        background: var(--bg-card);
        color: var(--text-body);
        width: 100%;
        transition: border-color 0.2s ease;
    }

    .search-wrapper input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb, 74, 144, 226), 0.15);
    }

    .search-wrapper input::placeholder {
        color: var(--text-muted);
    }

    .search-wrapper .search-clear {
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0;
        display: none;
    }

    /* ========== TEACHER CARDS ========== */
    .teacher-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 1rem;
    }

    .teacher-card {
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        overflow: hidden;
    }

    .teacher-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: transparent;
        transition: background 0.25s ease;
    }

    .teacher-card:hover {
        border-color: var(--primary-color);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .teacher-card:hover::before {
        background: var(--primary-color);
    }

    .teacher-card.selected {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }

    .teacher-card.selected::before {
        background: var(--primary-color);
    }

    .teacher-card .avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--primary-gradient);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    [data-theme="dark"] .teacher-card .avatar {
        color: #13273F;
    }

    .teacher-card .teacher-name {
        font-weight: 600;
        color: var(--text-heading);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .teacher-card .teacher-designation {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .teacher-card .workload-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 20px;
        background: var(--info-light, rgba(74, 144, 226, 0.1));
        color: var(--info-color, #4A90E2);
        white-space: nowrap;
    }

    /* ========== SECTION HEADER ========== */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .section-header h4 {
        font-weight: 700;
        margin: 0;
    }

    .section-header .count-badge {
        background: var(--primary-light);
        color: var(--primary-color);
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.3rem 0.75rem;
        border-radius: 20px;
    }

    /* ========== STATE BOXES ========== */
    .state-box {
        text-align: center;
        padding: 3rem 2rem;
    }

    .state-box .state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }

    .state-box h5 {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* ========== DASHBOARD PANEL ========== */
    .dashboard-panel {
        animation: fadeInUp 0.35s ease-out;
    }

    .profile-avatar-lg {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary-gradient);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 2rem;
        margin: 0 auto 1rem;
    }

    [data-theme="dark"] .profile-avatar-lg {
        color: #13273F;
    }

    .workload-bar .progress {
        height: 10px;
        border-radius: 5px;
        background: var(--bg-secondary);
    }

    .workload-bar .progress-bar {
        background: var(--primary-gradient);
        border-radius: 5px;
    }

    .stat-box {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 0.75rem;
        text-align: center;
    }

    .stat-box h4 {
        margin-bottom: 0;
        font-weight: 700;
    }

    .pref-tag {
        display: inline-block;
        background: var(--primary-light);
        color: var(--primary-color);
        padding: 0.3rem 0.65rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        margin: 0.2rem;
    }

    .subject-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 0.45rem 0.75rem;
        font-size: 0.82rem;
        margin: 0.2rem;
    }

    .subject-chip .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .subject-chip .dot.theory {
        background: var(--primary-color);
    }

    .subject-chip .dot.lab {
        background: var(--success-color);
    }

    /* Highlight matching text in search */
    .highlight {
        background: rgba(255, 200, 50, 0.35);
        border-radius: 2px;
    }

    /* ========== ANIMATION ========== */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(12px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeInUp 0.35s ease-out;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .teacher-cards-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav class="tt-breadcrumb" id="breadcrumb">
        <a href="{% url 'home' %}">Home</a>
        <span class="separator">›</span>
        <span class="current" id="bc-page">Teacher Timetable</span>
    </nav>

    <!-- Header -->
    <div class="mb-4">
        <h2 class="fw-bold mb-1"><i class="bi bi-search me-2"></i>Teacher Timetable Lookup</h2>
        <p class="text-muted mb-0">
            {{ config.current_academic_year }} — {{ config.active_semester_type }} Semesters
        </p>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator" id="step-indicator">
        <div class="step-dot active" id="step1-dot">1</div>
        <span class="step-label">Department</span>
        <div class="step-line" id="step1-line"></div>
        <div class="step-dot" id="step2-dot">2</div>
        <span class="step-label">Teacher</span>
        <div class="step-line" id="step2-line"></div>
        <div class="step-dot" id="step3-dot">3</div>
        <span class="step-label">Dashboard</span>
    </div>

    <!-- Step 1: Department Selector -->
    <div class="card card-custom p-4 mb-4">
        <div class="section-header">
            <h4><i class="bi bi-building me-2"></i>Select Department</h4>
        </div>
        <div style="max-width: 480px;">
            <select class="form-select" id="department-select"
                style="font-size: 1rem; padding: 0.85rem 1.25rem; font-weight: 500;">
                <option value="">— Choose a department —</option>
            </select>
        </div>
        <div id="dept-loading" class="mt-3" style="display: none;">
            <div class="d-flex align-items-center gap-2 text-muted">
                <div class="spinner-border spinner-border-sm" role="status"></div>
                <span>Loading departments...</span>
            </div>
        </div>
        <div id="dept-error" class="mt-3" style="display: none;">
            <div class="alert alert-danger mb-0 d-flex align-items-center gap-2">
                <i class="bi bi-exclamation-triangle"></i>
                <span id="dept-error-msg">Failed to load departments.</span>
                <button class="btn btn-sm btn-outline-danger ms-auto" onclick="loadDepartments()">Retry</button>
            </div>
        </div>
    </div>

    <!-- Step 2: Teachers List with Search -->
    <div id="teachers-section" style="display: none;">
        <div class="card card-custom p-4 mb-4 fade-in">
            <div class="section-header">
                <h4><i class="bi bi-people me-2"></i>Teachers in <span id="dept-name-display"></span></h4>
                <span class="count-badge" id="teacher-count"></span>
            </div>

            <!-- Search Bar -->
            <div class="search-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input type="text" id="teacher-search" placeholder="Search by name or email..." autocomplete="off">
                <button class="search-clear" id="search-clear" onclick="clearSearch()">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>

            <!-- Loading -->
            <div id="teacher-loading" class="state-box" style="display: none;">
                <div class="spinner-border text-primary state-icon" role="status" style="width: 3rem; height: 3rem;">
                </div>
                <h5 class="text-muted">Loading teachers...</h5>
            </div>

            <!-- Error -->
            <div id="teacher-error" class="state-box" style="display: none;">
                <i class="bi bi-exclamation-triangle text-danger state-icon"></i>
                <h5>Failed to load teachers</h5>
                <p class="text-muted" id="teacher-error-msg"></p>
                <button class="btn btn-gradient mt-2" onclick="loadTeachers()"><i
                        class="bi bi-arrow-clockwise me-1"></i>Retry</button>
            </div>

            <!-- No Teachers -->
            <div id="teacher-empty" class="state-box" style="display: none;">
                <i class="bi bi-person-x text-muted state-icon"></i>
                <h5 class="text-muted">No teachers found</h5>
                <p class="text-muted">There are no active teachers in this department.</p>
            </div>

            <!-- No Search Results -->
            <div id="search-empty" class="state-box" style="display: none;">
                <i class="bi bi-search text-muted state-icon"></i>
                <h5 class="text-muted">No matching teachers</h5>
                <p class="text-muted">Try a different search term.</p>
            </div>

            <!-- Teacher Cards -->
            <div class="teacher-cards-grid" id="teacher-cards-grid"></div>
        </div>
    </div>

    <!-- Step 3: Full Dashboard -->
    <div id="dashboard-section" style="display: none;">
        <div class="dashboard-panel">
            <!-- Dashboard Loading -->
            <div id="dashboard-loading" class="card card-custom p-4 mb-4" style="display: none;">
                <div class="state-box">
                    <div class="spinner-border text-primary state-icon" role="status"
                        style="width: 3rem; height: 3rem;"></div>
                    <h5 class="text-muted">Loading dashboard...</h5>
                </div>
            </div>

            <!-- Dashboard Error -->
            <div id="dashboard-error" class="card card-custom p-4 mb-4" style="display: none;">
                <div class="state-box">
                    <i class="bi bi-exclamation-triangle text-danger state-icon"></i>
                    <h5>Failed to load dashboard</h5>
                    <p class="text-muted" id="dashboard-error-msg"></p>
                    <button class="btn btn-gradient mt-2" onclick="loadDashboard()"><i
                            class="bi bi-arrow-clockwise me-1"></i>Retry</button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" style="display: none;">
                <div class="row">
                    <!-- Left Column: Profile + Workload + Preferences -->
                    <div class="col-lg-4 mb-4">
                        <!-- Profile Card -->
                        <div class="card card-custom p-4 mb-4">
                            <div class="text-center mb-3">
                                <div class="profile-avatar-lg" id="dash-avatar"></div>
                                <h4 class="fw-bold mb-1" id="dash-name"></h4>
                                <p class="text-muted mb-0" id="dash-designation"></p>
                            </div>
                            <hr style="border-color: var(--border-color);">
                            <div class="mb-3">
                                <small class="text-muted d-block">Email</small>
                                <span id="dash-email"></span>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted d-block">Department</small>
                                <span id="dash-department"></span>
                            </div>
                            <div>
                                <small class="text-muted d-block">Current Semester</small>
                                <span class="badge badge-gradient" id="dash-semester"></span>
                            </div>
                        </div>

                        <!-- Workload Card -->
                        <div class="card card-custom p-4 mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-graph-up me-2"></i>Workload Summary
                            </h5>
                            <div class="workload-bar mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Current Load</span>
                                    <span class="fw-bold" id="dash-workload-text"></span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" id="dash-workload-bar" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="row text-center g-2">
                                <div class="col-6">
                                    <div class="stat-box">
                                        <h4 id="dash-max-hours"></h4>
                                        <small class="text-muted">Max Hours</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-box">
                                        <h4 id="dash-available"></h4>
                                        <small class="text-muted">Available</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Card -->
                        <div class="card card-custom p-4 mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-heart me-2"></i>Subject Preferences
                            </h5>
                            <div id="dash-preferences"></div>
                        </div>

                        <!-- Assigned Subjects Card -->
                        <div class="card card-custom p-4">
                            <h5 class="fw-bold mb-3">
                                <i class="bi bi-book me-2"></i>Assigned Subjects
                            </h5>
                            <div id="dash-subjects"></div>
                        </div>
                    </div>

                    <!-- Right Column: Timetable -->
                    <div class="col-lg-8">
                        <div class="card card-custom p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                                <h4 class="fw-bold mb-0">
                                    <i class="bi bi-calendar-week me-2"></i>Weekly Timetable
                                </h4>
                                <a href="#" id="export-btn" class="btn btn-outline-custom btn-sm"
                                    style="display: none;">
                                    <i class="bi bi-download me-1"></i>Export PDF
                                </a>
                            </div>

                            <!-- No Timetable -->
                            <div id="timetable-empty" class="state-box" style="display: none;">
                                <i class="bi bi-calendar-x text-muted state-icon"></i>
                                <h5 class="text-muted">No timetable assigned</h5>
                                <p class="text-muted">This teacher does not have a timetable for the current semester.
                                </p>
                            </div>

                            <!-- Timetable Grid -->
                            <div id="timetable-container" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table timetable-grid mb-0">
                                        <thead>
                                            <tr id="timetable-header">
                                                <th style="width: 100px;">Day</th>
                                            </tr>
                                        </thead>
                                        <tbody id="timetable-body"></tbody>
                                    </table>
                                </div>
                                <div class="mt-3 d-flex gap-3">
                                    <div class="d-flex align-items-center">
                                        <div style="width: 20px; height: 20px; background: var(--primary-light); border-radius: 4px;"
                                            class="me-2"></div>
                                        <small class="text-muted">Theory</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div style="width: 20px; height: 20px; background: var(--success-light); border-radius: 4px;"
                                            class="me-2"></div>
                                        <small class="text-muted">Lab</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ========== URL CONSTANTS (rendered by Django) ==========
    const URL_HOME = "{% url 'home' %}";
    const URL_API_DEPARTMENTS = "{% url 'api_departments' %}";
    const URL_API_TEACHERS = "{% url 'api_teachers' %}";
    const URL_API_TIMETABLE = "{% url 'api_teacher_timetable' %}";
    const URL_EXPORT_PDF = "{% url 'export_timetable_pdf' %}";

    // ========== STATE ==========
    let selectedDepartmentId = null;
    let selectedDepartmentName = '';
    let selectedTeacherId = null;
    let selectedTeacherName = '';
    let allTeachers = []; // cached for client-side search
    let searchDebounceTimer = null;

    // ========== BREADCRUMB ==========
    function updateBreadcrumb(dept, teacher) {
        const bc = document.getElementById('breadcrumb');
        let html = `<a href="${URL_HOME}">Home</a><span class="separator">›</span>`;

        if (!dept) {
            html += '<span class="current">Teacher Timetable</span>';
        } else if (!teacher) {
            html += '<a href="#" onclick="resetToDepartment(); return false;">Teacher Timetable</a>';
            html += '<span class="separator">›</span>';
            html += `<span class="current">${dept}</span>`;
        } else {
            html += '<a href="#" onclick="resetToDepartment(); return false;">Teacher Timetable</a>';
            html += '<span class="separator">›</span>';
            html += `<a href="#" onclick="resetToTeacherList(); return false;">${dept}</a>`;
            html += '<span class="separator">›</span>';
            html += `<span class="current">${teacher}</span>`;
        }

        bc.innerHTML = html;
    }

    function resetToDepartment() {
        document.getElementById('department-select').value = '';
        document.getElementById('department-select').dispatchEvent(new Event('change'));
    }

    function resetToTeacherList() {
        selectedTeacherId = null;
        selectedTeacherName = '';
        document.getElementById('dashboard-section').style.display = 'none';
        document.querySelectorAll('.teacher-card').forEach(c => c.classList.remove('selected'));
        updateSteps(2);
        updateBreadcrumb(selectedDepartmentName, null);
    }

    // ========== STEP INDICATOR ==========
    function updateSteps(step) {
        const dots = [document.getElementById('step1-dot'), document.getElementById('step2-dot'), document.getElementById('step3-dot')];
        const lines = [document.getElementById('step1-line'), document.getElementById('step2-line')];

        dots.forEach((dot, i) => {
            dot.classList.remove('active', 'completed');
            if (i + 1 < step) dot.classList.add('completed');
            else if (i + 1 === step) dot.classList.add('active');
        });

        lines.forEach((line, i) => {
            line.classList.toggle('active', i + 1 < step);
        });
    }

    // ========== DEPARTMENT LOADING ==========
    function loadDepartments() {
        const select = document.getElementById('department-select');
        const loading = document.getElementById('dept-loading');
        const error = document.getElementById('dept-error');

        loading.style.display = 'block';
        error.style.display = 'none';
        select.disabled = true;

        fetch(URL_API_DEPARTMENTS)
            .then(r => { if (!r.ok) throw new Error('Server error'); return r.json(); })
            .then(data => {
                loading.style.display = 'none';
                select.disabled = false;
                if (!data.success) { showDeptError(data.error || 'Unknown error'); return; }
                select.innerHTML = '<option value="">— Choose a department —</option>';
                data.departments.forEach(dept => {
                    const opt = document.createElement('option');
                    opt.value = dept.id;
                    opt.textContent = dept.full_name;
                    select.appendChild(opt);
                });
            })
            .catch(err => {
                loading.style.display = 'none';
                select.disabled = false;
                showDeptError(err.message);
            });
    }

    function showDeptError(msg) {
        document.getElementById('dept-error').style.display = 'block';
        document.getElementById('dept-error-msg').textContent = msg;
    }

    // ========== DEPARTMENT CHANGE ==========
    document.getElementById('department-select').addEventListener('change', function () {
        selectedDepartmentId = this.value;
        selectedTeacherId = null;
        selectedTeacherName = '';

        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('teacher-search').value = '';
        document.getElementById('search-clear').style.display = 'none';

        if (!selectedDepartmentId) {
            document.getElementById('teachers-section').style.display = 'none';
            selectedDepartmentName = '';
            updateSteps(1);
            updateBreadcrumb(null, null);
            return;
        }

        selectedDepartmentName = this.options[this.selectedIndex].textContent;
        updateSteps(2);
        updateBreadcrumb(selectedDepartmentName, null);
        loadTeachers();
    });

    // ========== TEACHER LOADING ==========
    function loadTeachers() {
        const section = document.getElementById('teachers-section');
        const grid = document.getElementById('teacher-cards-grid');
        const loading = document.getElementById('teacher-loading');
        const error = document.getElementById('teacher-error');
        const empty = document.getElementById('teacher-empty');
        const searchEmpty = document.getElementById('search-empty');

        section.style.display = 'block';
        grid.innerHTML = '';
        loading.style.display = 'block';
        error.style.display = 'none';
        empty.style.display = 'none';
        searchEmpty.style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'none';

        fetch(`${URL_API_TEACHERS}?department_id=${selectedDepartmentId}`)
            .then(r => { if (!r.ok) throw new Error('Server error'); return r.json(); })
            .then(data => {
                loading.style.display = 'none';
                if (!data.success) { showTeacherError(data.error || 'Unknown error'); return; }

                document.getElementById('dept-name-display').textContent =
                    data.department ? `${data.department.code} - ${data.department.name}` : '';

                allTeachers = data.teachers;

                if (data.teachers.length === 0) {
                    empty.style.display = 'block';
                    document.getElementById('teacher-count').textContent = '0 teachers';
                    return;
                }

                document.getElementById('teacher-count').textContent =
                    `${data.teachers.length} teacher${data.teachers.length > 1 ? 's' : ''}`;

                renderTeacherCards(data.teachers, '');
            })
            .catch(err => {
                loading.style.display = 'none';
                showTeacherError(err.message);
            });
    }

    function showTeacherError(msg) {
        document.getElementById('teacher-error').style.display = 'block';
        document.getElementById('teacher-error-msg').textContent = msg;
    }

    function renderTeacherCards(teachers, query) {
        const grid = document.getElementById('teacher-cards-grid');
        grid.innerHTML = '';

        teachers.forEach(teacher => {
            const initials = teacher.name.split(' ')
                .filter(p => !['Dr.', 'Mr.', 'Ms.', 'Mrs.', 'Prof.'].includes(p))
                .map(p => p.charAt(0).toUpperCase()).join('');

            const displayName = query ? highlightMatch(teacher.name, query) : teacher.name;
            const displayEmail = query ? highlightMatch(teacher.email || '', query) : (teacher.email || '');

            const card = document.createElement('div');
            card.className = 'teacher-card';
            card.setAttribute('data-teacher-id', teacher.id);
            if (selectedTeacherId === teacher.id) card.classList.add('selected');

            card.innerHTML = `
                <div class="d-flex align-items-center gap-3 mb-2">
                    <div class="avatar">${initials || '?'}</div>
                    <div style="flex:1; min-width:0;">
                        <div class="teacher-name">${displayName}</div>
                        <div class="teacher-designation">${teacher.designation}</div>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">${displayEmail}</small>
                    <span class="workload-badge">${teacher.current_workload}/${teacher.max_hours} hrs</span>
                </div>
            `;

            card.addEventListener('click', () => selectTeacher(teacher));
            grid.appendChild(card);
        });
    }

    function highlightMatch(text, query) {
        if (!query) return text;
        const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        return text.replace(new RegExp(`(${escaped})`, 'gi'), '<span class="highlight">$1</span>');
    }

    // ========== SEARCH ==========
    document.getElementById('teacher-search').addEventListener('input', function () {
        const q = this.value.trim().toLowerCase();
        document.getElementById('search-clear').style.display = q ? 'block' : 'none';

        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(() => {
            const filtered = allTeachers.filter(t =>
                t.name.toLowerCase().includes(q) || (t.email && t.email.toLowerCase().includes(q))
            );

            const searchEmpty = document.getElementById('search-empty');
            const teacherEmpty = document.getElementById('teacher-empty');

            if (filtered.length === 0 && allTeachers.length > 0) {
                document.getElementById('teacher-cards-grid').innerHTML = '';
                searchEmpty.style.display = 'block';
                teacherEmpty.style.display = 'none';
            } else {
                searchEmpty.style.display = 'none';
                teacherEmpty.style.display = 'none';
                renderTeacherCards(filtered, q);
            }

            document.getElementById('teacher-count').textContent =
                `${filtered.length} teacher${filtered.length !== 1 ? 's' : ''}`;
        }, 200);
    });

    function clearSearch() {
        const input = document.getElementById('teacher-search');
        input.value = '';
        document.getElementById('search-clear').style.display = 'none';
        document.getElementById('search-empty').style.display = 'none';
        renderTeacherCards(allTeachers, '');
        document.getElementById('teacher-count').textContent =
            `${allTeachers.length} teacher${allTeachers.length !== 1 ? 's' : ''}`;
    }

    // ========== TEACHER SELECTION ==========
    function selectTeacher(teacher) {
        selectedTeacherId = teacher.id;
        selectedTeacherName = teacher.name;

        document.querySelectorAll('.teacher-card').forEach(c => c.classList.remove('selected'));
        const card = document.querySelector(`.teacher-card[data-teacher-id="${teacher.id}"]`);
        if (card) card.classList.add('selected');

        updateSteps(3);
        updateBreadcrumb(selectedDepartmentName, teacher.name);
        loadDashboard();
    }

    // ========== DASHBOARD LOADING ==========
    function loadDashboard() {
        const section = document.getElementById('dashboard-section');
        const loading = document.getElementById('dashboard-loading');
        const error = document.getElementById('dashboard-error');
        const content = document.getElementById('dashboard-content');

        section.style.display = 'block';
        loading.style.display = 'block';
        error.style.display = 'none';
        content.style.display = 'none';

        // Smooth scroll to dashboard
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });

        fetch(`${URL_API_TIMETABLE}?teacher_id=${selectedTeacherId}`)
            .then(r => { if (!r.ok) throw new Error('Server error'); return r.json(); })
            .then(data => {
                loading.style.display = 'none';
                if (!data.success) {
                    document.getElementById('dashboard-error-msg').textContent = data.error || 'Unknown error';
                    error.style.display = 'block';
                    return;
                }

                renderDashboard(data);
                content.style.display = 'block';
            })
            .catch(err => {
                loading.style.display = 'none';
                document.getElementById('dashboard-error-msg').textContent = err.message;
                error.style.display = 'block';
            });
    }

    // ========== DASHBOARD RENDERING ==========
    function renderDashboard(data) {
        const t = data.teacher;

        // Avatar
        const initials = t.name.split(' ')
            .filter(p => !['Dr.', 'Mr.', 'Ms.', 'Mrs.', 'Prof.'].includes(p))
            .map(p => p.charAt(0).toUpperCase()).join('');
        document.getElementById('dash-avatar').textContent = initials || '?';

        // Profile
        document.getElementById('dash-name').textContent = t.name;
        document.getElementById('dash-designation').textContent = t.designation;
        document.getElementById('dash-email').textContent = t.email;
        document.getElementById('dash-department').textContent = `${t.department_code} - ${t.department_name}`;
        document.getElementById('dash-semester').textContent = data.semester_instance;

        // Workload
        const pct = t.max_hours > 0 ? Math.round((t.current_workload / t.max_hours) * 100) : 0;
        document.getElementById('dash-workload-text').textContent = `${t.current_workload} / ${t.max_hours} hrs`;
        document.getElementById('dash-workload-bar').style.width = `${pct}%`;
        document.getElementById('dash-max-hours').textContent = t.max_hours;
        document.getElementById('dash-available').textContent = t.available_hours;

        // Preferences
        const prefsEl = document.getElementById('dash-preferences');
        if (t.preferences && t.preferences.trim()) {
            const prefs = t.preferences.split(',').map(p => p.trim()).filter(p => p);
            prefsEl.innerHTML = prefs.map(p => `<span class="pref-tag">${p}</span>`).join('');
        } else {
            prefsEl.innerHTML = '<p class="text-muted mb-0"><i>No preferences set</i></p>';
        }

        // Assigned Subjects
        const subjectsEl = document.getElementById('dash-subjects');
        if (data.assigned_subjects && data.assigned_subjects.length > 0) {
            subjectsEl.innerHTML = data.assigned_subjects.map(s =>
                `<div class="subject-chip">
                    <span class="dot ${s.is_lab ? 'lab' : 'theory'}"></span>
                    <strong>${s.code}</strong> — ${s.name}
                    <small class="text-muted">(${s.class_section})</small>
                </div>`
            ).join('');
        } else {
            subjectsEl.innerHTML = '<p class="text-muted mb-0"><i>No subjects assigned</i></p>';
        }

        // Export button
        const exportBtn = document.getElementById('export-btn');
        exportBtn.href = `${URL_EXPORT_PDF}?type=faculty&id=${t.id}`;

        // Timetable
        const ttContainer = document.getElementById('timetable-container');
        const ttEmpty = document.getElementById('timetable-empty');

        if (!data.has_timetable) {
            ttContainer.style.display = 'none';
            ttEmpty.style.display = 'block';
            exportBtn.style.display = 'none';
        } else {
            ttEmpty.style.display = 'none';
            renderTimetable(data);
            ttContainer.style.display = 'block';
            exportBtn.style.display = 'inline-block';
        }
    }

    // ========== TIMETABLE RENDERING ==========
    function renderTimetable(data) {
        const header = document.getElementById('timetable-header');
        const tbody = document.getElementById('timetable-body');

        // Generate headers for periods
        header.innerHTML = '<th style="width: 100px;">Day</th>';
        data.timetable.forEach(pRow => {
            const th = document.createElement('th');
            th.className = 'text-center';
            const periodTime = data.period_times[pRow.period] || '';
            th.innerHTML = `<div>P${pRow.period}</div><small class="text-muted">${periodTime}</small>`;
            header.appendChild(th);
        });

        tbody.innerHTML = '';
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

        days.forEach((dayName, dayIdx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="fw-bold align-middle">${dayName}</td>`;

            // Fill columns for each period
            data.timetable.forEach(pRow => {
                const cell = pRow.cells[dayIdx];
                const td = document.createElement('td');
                if (cell && cell.has_entry) {
                    const div = document.createElement('div');
                    div.className = `timetable-cell ${cell.is_lab ? 'lab' : 'theory'}`;
                    let content = `<div class="fw-bold">${cell.subject_name}</div>`;
                    content += `<small>${cell.class_section}</small>`;
                    if (cell.room) content += `<small class="d-block text-muted">Room: ${cell.room}</small>`;
                    if (cell.is_assistant) content += `<small class="text-warning d-block">(Assistant)</small>`;
                    div.innerHTML = content;
                    td.appendChild(div);
                } else {
                    td.innerHTML = '<span class="text-muted">—</span>';
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', loadDepartments);
</script>
{% endblock %}