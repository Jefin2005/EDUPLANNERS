{% extends 'base.html' %}
{% block title %}Teacher Timetable Lookup - EDUPLANNER{% endblock %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1"><i class="bi bi-person-lines-fill me-2"></i>Teacher Timetable Lookup</h2>
      <p class="text-muted mb-0">{{ config.current_academic_year }} – {{ config.active_semester_type }} Semesters</p>
    </div>
    <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-custom"><i class="bi bi-arrow-left me-1"></i>Back to Dashboard</a>
  </div>
  <div class="card card-custom p-3 mb-4">
    <div class="d-flex align-items-center justify-content-center gap-2 flex-wrap">
      <div class="d-flex align-items-center">
        <span class="d-inline-flex align-items-center justify-content-center rounded-circle fw-bold me-2" style="width:32px;height:32px;font-size:.85rem;{% if step >= 1 %}background:var(--primary-color);color:#fff{% else %}background:var(--bg-secondary);color:var(--text-muted){% endif %}">1</span>
        <span class="{% if step >= 1 %}fw-semibold{% else %}text-muted{% endif %}">Department</span>
      </div>
      <i class="bi bi-chevron-right text-muted mx-1"></i>
      <div class="d-flex align-items-center">
        <span class="d-inline-flex align-items-center justify-content-center rounded-circle fw-bold me-2" style="width:32px;height:32px;font-size:.85rem;{% if step >= 2 %}background:var(--primary-color);color:#fff{% else %}background:var(--bg-secondary);color:var(--text-muted){% endif %}">2</span>
        <span class="{% if step >= 2 %}fw-semibold{% else %}text-muted{% endif %}">Teacher</span>
      </div>
      <i class="bi bi-chevron-right text-muted mx-1"></i>
      <div class="d-flex align-items-center">
        <span class="d-inline-flex align-items-center justify-content-center rounded-circle fw-bold me-2" style="width:32px;height:32px;font-size:.85rem;{% if step >= 3 %}background:var(--primary-color);color:#fff{% else %}background:var(--bg-secondary);color:var(--text-muted){% endif %}">3</span>
        <span class="{% if step >= 3 %}fw-semibold{% else %}text-muted{% endif %}">Timetable</span>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-4 mb-4">
      <div class="card card-custom p-4 mb-4">
        <h5 class="fw-bold mb-3"><i class="bi bi-building me-2"></i>Select Department</h5>
        <div class="row g-2">
          {% for dept in departments %}
          <div class="col-6">
            <a href="?department={{ dept.id }}" class="d-block text-decoration-none p-3 rounded-3 text-center" style="border:1px solid {% if dept.is_selected %}var(--primary-color){% else %}var(--border-color){% endif %};background:{% if dept.is_selected %}var(--primary-light){% else %}var(--bg-card){% endif %};color:var(--text-heading);transition:all .2s ease">
              <div class="fw-bold" style="font-size:.9rem">{{ dept.code }}</div>
              <div class="text-muted" style="font-size:.7rem;line-height:1.2;margin-top:2px">{{ dept.name }}</div>
            </a>
          </div>
          {% empty %}
          <div class="col-12"><p class="text-muted text-center py-3 mb-0">No departments available</p></div>
          {% endfor %}
        </div>
      </div>
      {% if step >= 2 %}
      <div class="card card-custom p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold mb-0"><i class="bi bi-people me-2"></i>Teachers</h5>
          <span class="badge badge-primary">{{ teachers|length }}</span>
        </div>
        <div class="list-group list-group-flush" style="max-height:400px;overflow-y:auto">
          {% for teacher in teachers %}
          <a href="?department={{ selected_department.id }}&teacher={{ teacher.id }}" class="list-group-item list-group-item-action border-0 mb-1 rounded-3 px-3 py-2" style="background:{% if teacher.is_selected %}var(--primary-light){% else %}transparent{% endif %};{% if teacher.is_selected %}border-left:3px solid var(--primary-color) !important{% endif %}">
            <div class="fw-semibold" style="color:var(--text-heading);font-size:.95rem">{{ teacher.name }}</div>
            <div style="font-size:.8rem;color:var(--text-muted);line-height:1.3">{{ teacher.designation }}</div>
            <div style="font-size:.75rem;color:var(--text-muted)"><i class="bi bi-envelope me-1"></i>{{ teacher.email }}</div>
          </a>
          {% empty %}
          <div class="text-center py-4">
            <i class="bi bi-people display-4 text-muted d-block mb-2"></i>
            <p class="text-muted mb-0">No teachers in this department</p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    <div class="col-lg-8">
      {% if step == 1 %}
      <div class="card card-custom p-5 text-center">
        <i class="bi bi-building display-3 text-muted d-block mb-3"></i>
        <h4 class="fw-bold">Select a Department</h4>
        <p class="text-muted mb-0">Choose a department from the grid on the left to see its teachers.</p>
      </div>
      {% elif step == 2 %}
      <div class="card card-custom p-5 text-center">
        <i class="bi bi-person-check display-3 text-muted d-block mb-3"></i>
        <h4 class="fw-bold">Select a Teacher</h4>
        <p class="text-muted mb-0">Showing teachers from <strong>{{ selected_department.full_name }}</strong>.<br>Pick a teacher from the list to view their timetable.</p>
      </div>
      {% elif step == 3 %}
      <div class="card card-custom p-4 mb-4">
        <div class="row align-items-center">
          <div class="col-auto">
            <div class="rounded-circle d-flex align-items-center justify-content-center" style="width:64px;height:64px;background:var(--primary-gradient);font-size:1.5rem;color:#fff">{{ selected_teacher.name|slice:":1" }}</div>
          </div>
          <div class="col">
            <h4 class="fw-bold mb-0">{{ selected_teacher.name }}</h4>
            <p class="text-muted mb-0">{{ selected_teacher.designation }} · {{ selected_department.full_name }}</p>
            <small class="text-muted"><i class="bi bi-envelope me-1"></i>{{ selected_teacher.email }}</small>
          </div>
          <div class="col-auto text-end">
            <div class="d-flex gap-3">
              <div class="text-center p-2 rounded-3" style="background:var(--bg-secondary);min-width:80px">
                <div class="fw-bold fs-5" style="color:var(--text-heading)">{{ selected_teacher.current_workload }}</div>
                <small class="text-muted">Current Hrs</small>
              </div>
              <div class="text-center p-2 rounded-3" style="background:var(--bg-secondary);min-width:80px">
                <div class="fw-bold fs-5" style="color:var(--text-heading)">{{ selected_teacher.max_hours }}</div>
                <small class="text-muted">Max Hrs</small>
              </div>
              <div class="text-center p-2 rounded-3" style="background:var(--success-light);min-width:80px">
                <div class="fw-bold fs-5" style="color:var(--success-color)">{{ selected_teacher.available_hours }}</div>
                <small class="text-muted">Available</small>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <div class="d-flex justify-content-between mb-1">
            <small class="text-muted">Workload</small>
            <small class="fw-bold">{{ selected_teacher.current_workload }} / {{ selected_teacher.max_hours }} hrs</small>
          </div>
          <div class="progress" style="height:8px;background:var(--bg-secondary);border-radius:4px">
            <div class="progress-bar" role="progressbar" style="width:{{ selected_teacher.workload_pct }}%;background:var(--primary-gradient);border-radius:4px" aria-valuenow="{{ selected_teacher.current_workload }}" aria-valuemin="0" aria-valuemax="{{ selected_teacher.max_hours }}"></div>
          </div>
        </div>
      </div>
      {% if has_timetable %}
      <div class="card card-custom p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold mb-0"><i class="bi bi-calendar-week me-2"></i>Weekly Schedule</h5>
          <a href="{% url 'export_timetable_pdf' %}?type=faculty&id={{ selected_teacher.id }}" class="btn btn-outline-custom btn-sm"><i class="bi bi-download me-1"></i>Export PDF</a>
        </div>
        {% include 'timetable/grid.html' with grid=timetable_grid period_headers=period_headers legend=legend %}
      </div>
      {% else %}
      <div class="card card-custom p-5 text-center">
        <i class="bi bi-calendar-x display-3 text-muted d-block mb-3"></i>
        <h5 class="text-muted">No Timetable Assigned</h5>
        <p class="text-muted mb-0">{{ selected_teacher.name }} does not have a timetable for the current semester yet.</p>
      </div>
      {% endif %}
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
