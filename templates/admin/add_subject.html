{% extends 'base.html' %}

{% block title %}{{ page_title }} - EDUPLANNER{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 750px;">
    <a href="{% url 'manage_subjects' %}" class="text-decoration-none text-muted mb-3 d-inline-block">
        <i class="bi bi-arrow-left me-1"></i> Back to Subjects
    </a>

    <h2 class="fw-bold mb-4"><i class="bi bi-book me-2"></i>{{ page_title }}</h2>

    <div class="card card-custom p-4">
        <form method="post">
            {% csrf_token %}

            <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Subject Code <span class="text-danger">*</span></label>
                    <input type="text" name="code" class="form-control" placeholder="e.g., CS401"
                        value="{{ form_data.code }}" required>
                    {% if errors.code %}<div class="text-danger small">{{ errors.code }}</div>{% endif %}
                    <small class="text-muted">Unique code like CS401, ME302</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Subject Name <span class="text-danger">*</span></label>
                    <input type="text" name="name" class="form-control" placeholder="e.g., Machine Learning"
                        value="{{ form_data.name }}" required>
                    {% if errors.name %}<div class="text-danger small">{{ errors.name }}</div>{% endif %}
                </div>
            </div>

            <div class="row mb-3">
                {% if show_dept_dropdown %}
                <div class="col-md-6 mb-3">
                    <label class="form-label">Department <span class="text-danger">*</span></label>
                    <select name="department_id" id="departmentSelect" class="form-select" required
                        onchange="updateSemesters()">
                        <option value="">Select Department</option>
                        {% for dept in department_options %}
                        <option value="{{ dept.id }}" {{ dept.selected }}>{{ dept.code }} - {{ dept.name }}</option>
                        {% endfor %}
                    </select>
                    {% if errors.department %}<div class="text-danger small">{{ errors.department }}</div>{% endif %}
                </div>
                {% else %}
                <input type="hidden" name="department_id" value="{{ preset_dept.id }}">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Department</label>
                    <input type="text" class="form-control" value="{{ preset_dept.code }} - {{ preset_dept.name }}"
                        disabled>
                </div>
                {% endif %}

                {% if show_sem_dropdown %}
                <div class="col-md-6 mb-3">
                    <label class="form-label">Semester <span class="text-danger">*</span></label>
                    <select name="semester_id" id="semesterSelect" class="form-select" required>
                        <option value="">Select Department First</option>
                    </select>
                    {% if errors.semester %}<div class="text-danger small">{{ errors.semester }}</div>{% endif %}
                </div>
                {% else %}
                <input type="hidden" name="semester_id" value="{{ preset_sem.id }}">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Semester</label>
                    <input type="text" class="form-control" value="Semester {{ preset_sem.number }}" disabled>
                </div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label">Subject Type <span class="text-danger">*</span></label>
                <div class="d-flex gap-3 flex-wrap">
                    {% for type_opt in type_options %}
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="subject_type" id="type_{{ type_opt.value }}"
                            value="{{ type_opt.value }}" {{ type_opt.checked }}>
                        <label class="form-check-label" for="type_{{ type_opt.value }}"><i
                                class="{{ type_opt.icon }}"></i> {{ type_opt.label }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- L-T-P Hours Section (KTU B.Tech 2019 Scheme) -->
            <div class="card border-0 p-3 mb-4" style="background: var(--bg-secondary);">
                <label class="form-label fw-semibold mb-3">
                    <i class="bi bi-clock me-1"></i> Lecture-Tutorial-Practical Hours
                    <small class="text-muted fw-normal">(KTU Scheme)</small>
                </label>

                <div class="row g-3 mb-3">
                    <!-- Lecture Hours -->
                    <div class="col-md-4">
                        <label class="form-label small text-muted">Lecture (L)</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="decrementValue('lecture_hours')">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" name="lecture_hours" id="lecture_hours"
                                class="form-control text-center ltp-input" value="{{ form_data.lecture_hours }}" min="0"
                                max="6" required onchange="updateLTP()">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="incrementValue('lecture_hours')">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Tutorial Hours -->
                    <div class="col-md-4">
                        <label class="form-label small text-muted">Tutorial (T)</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="decrementValue('tutorial_hours')">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" name="tutorial_hours" id="tutorial_hours"
                                class="form-control text-center ltp-input" value="{{ form_data.tutorial_hours }}"
                                min="0" max="6" required onchange="updateLTP()">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="incrementValue('tutorial_hours')">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Practical Hours -->
                    <div class="col-md-4">
                        <label class="form-label small text-muted">Practical (P)</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="decrementValue('practical_hours')">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" name="practical_hours" id="practical_hours"
                                class="form-control text-center ltp-input" value="{{ form_data.practical_hours }}"
                                min="0" max="6" required onchange="updateLTP()">
                            <button class="btn btn-outline-secondary" type="button"
                                onclick="incrementValue('practical_hours')">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- L-T-P Summary Display -->
                <div class="d-flex justify-content-between align-items-center rounded p-2 px-3"
                    style="background: var(--bg-card);">
                    <div>
                        <span class="text-muted small">L-T-P:</span>
                        <span id="ltp-display" class="fw-bold text-primary ms-1">3-0-0</span>
                    </div>
                    <div>
                        <span class="text-muted small">Max Hours/Week:</span>
                        <span id="max-hours-display" class="fw-bold text-success ms-1">3 hrs</span>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Credits <span class="text-danger">*</span></label>
                    <input type="number" name="credits" id="credits" class="form-control"
                        value="{{ form_data.credits }}" min="1" max="6" required>
                    <small class="text-muted">Enter credits as per syllabus</small>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                <a href="{% url 'manage_subjects' %}" class="btn btn-outline-secondary">Cancel</a>
                <button type="submit" class="btn btn-gradient"><i class="bi bi-check-lg me-1"></i>{{ submit_label
                    }}</button>
            </div>
        </form>
    </div>
</div>

<script>
    const semestersByDept = {{ semesters_by_dept| safe }};
    const currentDeptId = "{{ current_dept_id }}";
    const currentSemId = "{{ current_sem_id }}";

    function updateSemesters() {
        const deptSelect = document.getElementById('departmentSelect');
        const semSelect = document.getElementById('semesterSelect');
        if (!deptSelect || !semSelect) return;

        const selectedDept = deptSelect.value;
        semSelect.innerHTML = '<option value="">Select Semester</option>';

        if (selectedDept && semestersByDept[selectedDept]) {
            semestersByDept[selectedDept].forEach(sem => {
                const option = document.createElement('option');
                option.value = sem.id;
                option.textContent = 'Semester ' + sem.number;
                if (currentSemId && sem.id == currentSemId) option.selected = true;
                semSelect.appendChild(option);
            });
        } else if (!selectedDept) {
            semSelect.innerHTML = '<option value="">Select Department First</option>';
        }
    }

    // L-T-P Stepper Functions
    function incrementValue(fieldId) {
        const input = document.getElementById(fieldId);
        const currentValue = parseInt(input.value) || 0;
        if (currentValue < 6) {
            input.value = currentValue + 1;
            updateLTP();
        }
    }

    function decrementValue(fieldId) {
        const input = document.getElementById(fieldId);
        const currentValue = parseInt(input.value) || 0;
        if (currentValue > 0) {
            input.value = currentValue - 1;
            updateLTP();
        }
    }

    function updateLTP() {
        const L = parseInt(document.getElementById('lecture_hours').value) || 0;
        const T = parseInt(document.getElementById('tutorial_hours').value) || 0;
        const P = parseInt(document.getElementById('practical_hours').value) || 0;

        // Update L-T-P display
        document.getElementById('ltp-display').textContent = `${L}-${T}-${P}`;

        // Update max hours display
        const maxHours = L + T + P;
        document.getElementById('max-hours-display').textContent = `${maxHours} hrs`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize semester dropdown
        if (currentDeptId) {
            const deptSelect = document.getElementById('departmentSelect');
            if (deptSelect) {
                deptSelect.value = currentDeptId;
                updateSemesters();
            }
        }

        // Initialize L-T-P display
        updateLTP();
    });
</script>
{% endblock %}